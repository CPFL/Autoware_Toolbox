# Usage example of vel_pose_connect_sl.slx

## 1. Run Autoware
Run Autoware to launch the ROS master.  
![run_autoware](../images/run_autoware.png)  

The Runtime Manager window is launched.  
![runtime_manager](../images/runtime_manager.png)  
<html><br></html>

## 2. Load vehicle model
Open the Setup tab of the Runtime Manager.
Load a vehicle model.  
![setup_tab_load_vehicle_model](../images/setup_tab_load_vehicle_model.png)  
<html><br></html>

## 3. Load vector map and TF
Open the Map tab of the Runtime Manager.
Load Vector Map and TF.  
![map_tab_load_vectormap_tf](../images/map_tab_load_vectormap_tf.png)  
<html><br></html>

## 4. Launch rviz
Launch the rviz by clicking the RViz button on the Runtime Manager.  
![click_rviz](../images/click_rviz.png)  

When rviz starts, select [File]-[Open Config] from the menu.  
![rviz_file_open_config](../images/rviz_file_open_config.png)  

Select " ~ / Autoware / ros / src / .config / rviz / default.rviz " on the file dialog.  
![choose_file_to_open](../images/choose_file_to_open.png)  

After Config setting, Vector Map is displayed on the rviz screen.  
![show_vectormap](../images/show_vectormap.png)  
<html><br></html>

## 5. Settings on the Runtime Manager's Computing tab
(1) Click "app" of *waypoint_loader* and select the csv file where the route is stored.  
![waypoint_loader](../images/waypoint_loader.png)  
After selecting the csv file, check the *waypoint_loader* checkbox.

(2) Click "app" of *wf_simulator* and set "Initialize Source" to "Rviz".  
![wf_simulator_app](../images/wf_simulator_app.png)  
After setting the "Initialize Source", check the *wf_simulator* checkbox.

(3) Check the checkboxes for lane_rule, lane_stop, lane_select, obstacle_avoid, 
velocity_set, pure_pursuit and twist_filter.
After setting, the Computing tab is as shown below.  
![computing_tab](images/vel_pose_connect/computing_tab.png)  
<html><br></html>

## 6. Connect MATLAB to Autoware (ROS Master)
Connect to the ROS master using the rosinit command in MATLAB.
Set the rosinit arguments according to your environment.  
```MATLAB  
rosinit();
```  

## 7. Open vel_pose_connect created in Simulink.
Add the folder containing the vel_pose_connect_sl.slx file to MATLAB search path, 
open the vel_pose_connect Simulink model.  
```MATLAB  
vel_pose_connect_folder = fullfile(autoware.getRootDirectory(), ...
                        'benchmark', 'computing', 'perception', 'localization', 'autoware_connector', 'vel_pose_connect');
addpath(vel_pose_connect_folder);
model = 'vel_pose_connect_sl';
open_system(model);
```
![vel_pose_connect_sl_top](images/vel_pose_connect/vel_pose_connect_sl_top.png)  

## 8. Run vel_pose_connect created in Simulink
Run the Simulink model.  
```MATLAB  
set_param(model, 'SimulationCommand', 'Start');
```

## 9. Set the initial position of the vehicle with rviz
 (1) Click "2D Pose Estimate" of rviz.
 (2) Next, drag the mouse in the direction of movement from the initial position of the vehicle.  
![2D_Pose_Estimate](images/2D_Pose_Estimate.png)  
<html><br></html>

## 10. Start path following
After a while after setting the initial position with rviz, path following starts.  
![result_waypoint_follower](images/result_waypoint_follower.png)  

Click
[here](images/vel_pose_connect/sl_rosgraph.png) to check the node graph when this example is executed.
The node generated by vel_pose_connect_sl.slx is " *_/vel_pose_connect_sl_81473_* ".

## 11. Clean up
Execute the following command to finish.  
```MATLAB  
set_param(model, 'SimulationCommand', 'Stop');
close_system(model);
rosshutdown();
rmpath(vel_pose_connect_folder);
clear('model', 'vel_pose_connect_folder');
```