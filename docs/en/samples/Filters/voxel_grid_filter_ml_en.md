# Usage example of VoxelGridFilter.m
 
## 1. Run Autoware
Run Autoware to launch the ROS master.  
![autoware](images/run_autoware.png)  

The Runtime Manager window is launched.  
![runtime_manager](images/runtime_manager.png)

## 2. Simulation clock setting
Open the Simulation tab of the Runtime Manager.
Click the "Ref" button to set the rosbag file to play.  
![set_rosbag](images/set_rosbag.png)  

Click the "Play" button to play rosbag (①), then click the "Pause" button to pause it (②).
This operation turns on the simulation clock.  
![simulation_clock_on](images/simulation_clock_on.png)

## 3. LiDAR mounting position setting and load vehicle model
Open the Setup tab of the Runtime Manager.
Select Velodyne in the localizer section.  
![set_localizer_velodyne](images/set_localizer_velodyne.png)

Set the parameters of the Baselink to Localizer section as follows, and click the "TF" button.  
![set_baselink_to_localizer](images/set_baselink_to_localizer.png)

Load the vehicle model by clicking the "Vehicle Model" button in the Vehicle Model section.
If you leave the file selection blank, the default car model is loaded.  
![load_vehicle_model](images/load_vehicle_model.png)

## 4. Loading of map data and TF
Open the Map tab of the Runtime Manager.  

1. Click the "Ref" button to the right of the "Point Cloud" button, select all pcd files to use for localization, and click the "Point Cloud" button.  
2. Click the "Ref" button on the right of the "TF" button, select the launch file with the TF information corresponding to the pcd data, and click the "TF" button.

![map_tab](images/map_tab.png)

## 5. Start nodes required to run this example
Open the Computing tab of the Runtime Manager.  
Click the app of *nmea2tfpose* to open the setting window, set the Plane number to "7", and click the "OK" button.  
![set_plane_number](images/set_plane_number.png)

Click the *ndt_matching* app to open the setting window, select "GNSS", and click the "OK" button.  
![ndt_matching_app](images/ndt_matching_app.png)

Check the checkboxes of *nmea2tfpose* and *ndt_matching* .  
![set_computing_tab](images/set_computing_tab.png)

## 6. Connect MATLAB to Autoware (ROS Master)
Connect to the ROS master using the rosinit command in MATLAB.  
```MATLAB
rosinit();
```
## 7. Start VoxelGridFilter.m
 Add the folder containing the VoxelGridFilter.m class file to MATLAB search path, create an instance of voxelGridFilter, and execute filtering.  
```MATLAB
voxel_grid_filter_folder = fullfile(autoware.getRootDirectory(), ...
                                    'benchmark', 'sensing', 'filters', 'points_downsampler', ...
                                    'voxel_grid_filter');
addpath(voxel_grid_filter_folder);
voxel_grid_filter_obj = VoxelGridFilter();
```

## 8. Play rosbag file
Open the Simulation tab of the Runtime Manager.
Click the "Pause" button to play rosbag.  
![replay_rosbag](images/replay_rosbag.png)

## 9. Launch rviz
Launch the rviz by clicking the RViz button on the Runtime Manager.    
![click_rviz](images/click_rviz.png)

When rviz starts, select "Autoware / ros / src / .config / rviz / default.rviz" from the [File]-[Open Config] menu.
The data loaded by Runtime Manager and rosbag data are displayed.  
![show_rviz](images/voxel_grid_filter_ml/show_rviz.png)

## 10. Checking filter processing
Set the topic of the point cluster to "/ points_raw" and check the point cloud before filtering.  
![points_raw](images/voxel_grid_filter_ml/points_raw.png)

Next, change the topic of Points Cluster to "/ filtered_points" and check the filtered point cloud.  
![filtered_points](images/voxel_grid_filter_ml/filtered_points.png)

You can confirm that it is downsampled.

Click
[here](images/voxel_grid_filter_ml/rosgraph_voxel_grid_filter_ml.png) to check the node graph image when executing this example, or click
[here](images/voxel_grid_filter_ml/rosgraph_voxel_grid_filter_ml.svg) to check the SVG file.
The node generated by VoxelGridFilter.m is / voxel_grid_filter_ml.

## 11. Clean up
Execute the following command to finish.  
```MATLAB
voxel_grid_filter_obj.delete()
rosshutdown();
rmpath(voxel_grid_filter_folder);
clear voxel_grid_filter_obj voxel_grid_filter_folder;
```